<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Generating Combination & Hash Lookup (PostgreSQL Spacing)</title>
    <script src="lib/md5/md5.js"></script>
    <!-- d3 -->
    <script type="text/javascript" src="lib/d3/d3.js"></script>

    <script>
////////////////////////////////////////////////////////////////////////////////
// 1) The decoding_dict from your question, used to populate dropdowns.
////////////////////////////////////////////////////////////////////////////////
const decodingDict = {
  "year": {
    "0": "2000",
    "1": "2005",
    "2": "2010",
    "3": "2015",
    "4": "2019",
    "5" : "All"
  },
  "region_name": {
    "0": "Asia",
    "1": "Oceania",
    "2": "Europe",
    "3": "Americas",
    "4": "Africa",
    "5" : "All"
  },
  "sub_region_name": {
    "0": "Eastern Asia",
    "1": "South-eastern Asia",
    "2": "Southern Asia",
    "3": "Melanesia",
    "4": "Micronesia",
    "5": "Polynesia",
    "6": "Western Asia",
    "7": "Central Asia",
    "8": "Southern Europe",
    "9": "Eastern Europe",
    "10": "Northern Europe",
    "11": "Australia and New Zealand",
    "12": "Western Europe",
    "13": "Latin America and the Caribbean",
    "14": "Northern America",
    "15": "Northern Africa",
    "16": "Sub-Saharan Africa",
    "17" : "All"
  },
  "location_name": {
    "0": "China",
    "1": "Democratic People's Republic of Korea",
    "2": "Taiwan (Province of China)",
    "3": "Cambodia",
    "4": "Indonesia",
    "5": "Lao People's Democratic Republic",
    "6": "Malaysia",
    "7": "Maldives",
    "8": "Myanmar",
    "9": "Philippines",
    "10": "Sri Lanka",
    "11": "Thailand",
    "12": "Timor-Leste",
    "13": "Viet Nam",
    "14": "Fiji",
    "15": "Kiribati",
    "16": "Marshall Islands",
    "17": "Micronesia (Federated States of)",
    "18": "Papua New Guinea",
    "19": "Samoa",
    "20": "Solomon Islands",
    "21": "Tonga",
    "22": "Vanuatu",
    "23": "Armenia",
    "24": "Azerbaijan",
    "25": "Georgia",
    "26": "Kazakhstan",
    "27": "Kyrgyzstan",
    "28": "Mongolia",
    "29": "Tajikistan",
    "30": "Turkmenistan",
    "31": "Uzbekistan",
    "32": "Albania",
    "33": "Bosnia and Herzegovina",
    "34": "Bulgaria",
    "35": "Croatia",
    "36": "Czechia",
    "37": "Hungary",
    "38": "North Macedonia",
    "39": "Montenegro",
    "40": "Poland",
    "41": "Romania",
    "42": "Serbia",
    "43": "Slovakia",
    "44": "Slovenia",
    "45": "Belarus",
    "46": "Estonia",
    "47": "Latvia",
    "48": "Lithuania",
    "49": "Republic of Moldova",
    "50": "Russian Federation",
    "51": "Ukraine",
    "52": "Brunei Darussalam",
    "53": "Japan",
    "54": "Republic of Korea",
    "55": "Singapore",
    "56": "Australia",
    "57": "New Zealand",
    "58": "Andorra",
    "59": "Austria",
    "60": "Belgium",
    "61": "Cyprus",
    "62": "Denmark",
    "63": "Finland",
    "64": "France",
    "65": "Germany",
    "66": "Greece",
    "67": "Iceland",
    "68": "Ireland",
    "69": "Israel",
    "70": "Italy",
    "71": "Luxembourg",
    "72": "Malta",
    "73": "Netherlands",
    "74": "Norway",
    "75": "Portugal",
    "76": "Spain",
    "77": "Sweden",
    "78": "Switzerland",
    "79": "United Kingdom",
    "80": "Argentina",
    "81": "Chile",
    "82": "Uruguay",
    "83": "Canada",
    "84": "United States of America",
    "85": "Antigua and Barbuda",
    "86": "Bahamas",
    "87": "Barbados",
    "88": "Belize",
    "89": "Cuba",
    "90": "Dominica",
    "91": "Dominican Republic",
    "92": "Grenada",
    "93": "Guyana",
    "94": "Haiti",
    "95": "Jamaica",
    "96": "Saint Lucia",
    "97": "Saint Vincent and the Grenadines",
    "98": "Suriname",
    "99": "Trinidad and Tobago",
    "100": "Bolivia (Plurinational State of)",
    "101": "Ecuador",
    "102": "Peru",
    "103": "Colombia",
    "104": "Costa Rica",
    "105": "El Salvador",
    "106": "Guatemala",
    "107": "Honduras",
    "108": "Mexico",
    "109": "Nicaragua",
    "110": "Panama",
    "111": "Venezuela (Bolivarian Republic of)",
    "112": "Brazil",
    "113": "Paraguay",
    "114": "Algeria",
    "115": "Bahrain",
    "116": "Egypt",
    "117": "Iran (Islamic Republic of)",
    "118": "Iraq",
    "119": "Jordan",
    "120": "Kuwait",
    "121": "Lebanon",
    "122": "Libya",
    "123": "Morocco",
    "124": "Palestine",
    "125": "Oman",
    "126": "Qatar",
    "127": "Saudi Arabia",
    "128": "Syrian Arab Republic",
    "129": "Tunisia",
    "130": "Turkey",
    "131": "United Arab Emirates",
    "132": "Yemen",
    "133": "Afghanistan",
    "134": "Bangladesh",
    "135": "Bhutan",
    "136": "India",
    "137": "Nepal",
    "138": "Pakistan",
    "139": "Angola",
    "140": "Central African Republic",
    "141": "Congo",
    "142": "Democratic Republic of the Congo",
    "143": "Equatorial Guinea",
    "144": "Gabon",
    "145": "Burundi",
    "146": "Comoros",
    "147": "Djibouti",
    "148": "Eritrea",
    "149": "Ethiopia",
    "150": "Kenya",
    "151": "Madagascar",
    "152": "Malawi",
    "153": "Mauritius",
    "154": "Mozambique",
    "155": "Rwanda",
    "156": "Seychelles",
    "157": "Somalia",
    "158": "United Republic of Tanzania",
    "159": "Uganda",
    "160": "Zambia",
    "161": "Botswana",
    "162": "Lesotho",
    "163": "Namibia",
    "164": "South Africa",
    "165": "Eswatini",
    "166": "Zimbabwe",
    "167": "Benin",
    "168": "Burkina Faso",
    "169": "Cameroon",
    "170": "Cabo Verde",
    "171": "Chad",
    "172": "C\u00f4te d'Ivoire",
    "173": "Gambia",
    "174": "Ghana",
    "175": "Guinea",
    "176": "Guinea-Bissau",
    "177": "Liberia",
    "178": "Mali",
    "179": "Mauritania",
    "180": "Niger",
    "181": "Nigeria",
    "182": "Sao Tome and Principe",
    "183": "Senegal",
    "184": "Sierra Leone",
    "185": "Togo",
    "186": "American Samoa",
    "187": "Bermuda",
    "188": "Cook Islands",
    "189": "Greenland",
    "190": "Guam",
    "191": "Monaco",
    "192": "Nauru",
    "193": "Niue",
    "194": "Northern Mariana Islands",
    "195": "Palau",
    "196": "Puerto Rico",
    "197": "Saint Kitts and Nevis",
    "198": "San Marino",
    "199": "Tokelau",
    "200": "Tuvalu",
    "201": "United States Virgin Islands",
    "202": "South Sudan",
    "203": "Sudan",
    "204" : "All"
  },
  "age_group_name_sorted": {
    "0": "01 to 04",
    "1": "05 to 09",
    "2": "10 to 14",
    "3": "15 to 19",
    "4": "20 to 24",
    "5": "25 to 29",
    "6": "30 to 34",
    "7": "35 to 39",
    "8": "40 to 44",
    "9": "45 to 49",
    "10": "50 to 54",
    "11": "55 to 59",
    "12": "60 to 64",
    "13": "65 to 69",
    "14": "70 to 74",
    "15": "75 to 79",
    "16": "00 years",
    "17": "80 to 84",
    "18": "85 to 89",
    "19": "90 to 94",
    "20": "95 plus",
    "21" : "All"
  },
  "age_cluster_name_sorted": {
    "0": "00 to 14",
    "1": "15 to 29",
    "2": "30 to 44",
    "3": "45 to 59",
    "4": "60 to 74",
    "5": "75 plus",
    "6" : "All"
  },
  "sex_name": {
    "0": "male",
    "1": "female",
    "2" : "All"
  },
  "l1_cause_name": {
    "0": "Communicable, maternal, neonatal, and nutritional diseases",
    "1": "Non-communicable diseases",
    "2": "Injuries",
    "3" : "All"
  },
  "l2_cause_name": {
    "0": "Neglected tropical diseases and malaria",
    "1": "Nutritional deficiencies",
    "2": "Neoplasms",
    "3": "Cardiovascular diseases",
    "4": "Chronic respiratory diseases",
    "5": "Digestive diseases",
    "6": "Neurological disorders",
    "7": "Mental disorders",
    "8": "Musculoskeletal disorders",
    "9": "Other non-communicable diseases",
    "10": "Skin and subcutaneous diseases",
    "11": "Sense organ diseases",
    "12": "Transport injuries",
    "13": "Unintentional injuries",
    "14": "Self-harm and interpersonal violence",
    "15": "HIV/AIDS and sexually transmitted infections",
    "16": "Respiratory infections and tuberculosis",
    "17": "Enteric infections",
    "18": "Other infectious diseases",
    "19": "Maternal and neonatal disorders",
    "20": "Substance use disorders",
    "21": "Diabetes and kidney diseases",
    "22": "All"
  }
};

// The exact order in which we build the string matters for MD5 hashing.
// Adjust this order if your PostgreSQL code uses a different order of keys!
const COL_ORDER = [
  "year",
  "region_name",
  "sub_region_name",
  "location_name",
  "age_group_name_sorted",
  "age_cluster_name_sorted",
  "sex_name",
  "l1_cause_name",
  "l2_cause_name"
];

////////////////////////////////////////////////////////////////////////////////
// 3) Build the form on page load from decodingDict
////////////////////////////////////////////////////////////////////////////////
window.onload = function() {
  const columns = [
    "year",
    "region_name",
    "sub_region_name",
    "location_name",
    "age_group_name_sorted",
    "age_cluster_name_sorted",
    "sex_name",
    "l1_cause_name",
    "l2_cause_name"
  ];

  // For each column, populate its <select> with the dictionary values
  columns.forEach(col => {
    const select = document.getElementById(col);
    if (!select) return; // In case we skip some columns in HTML

    // Create a placeholder option
    const blankOpt = document.createElement("option");
    blankOpt.value = "";
    blankOpt.textContent = "-- no selection --";
    select.appendChild(blankOpt);

    // Add one <option> per decoded value
    if (decodingDict[col]) {
      for (const key in decodingDict[col]) {
        const opt = document.createElement("option");
        opt.value = decodingDict[col][key];  // e.g. "China" or "2000"
        opt.textContent = decodingDict[col][key];
        select.appendChild(opt);
      }
    }
  });

  // Also build pivotCol dropdown
  const pivotColSelect = document.getElementById("pivotCol");
  const pivotBlank = document.createElement("option");
  pivotBlank.value = "";
  pivotBlank.textContent = "-- select pivot column --";
  pivotColSelect.appendChild(pivotBlank);

  // Each possible column (that might appear in the final JSON)
  COL_ORDER.forEach(col => {
    const opt = document.createElement("option");
    opt.value = col;
    opt.textContent = col;
    pivotColSelect.appendChild(opt);
  });
};

////////////////////////////////////////////////////////////////////////////////
// 4) Function to replicate PostgreSQL-style JSON formatting (with spaces).
//    Returns something like:
//    {"region_name" : "Asia", "sub_region_name" : "Eastern Asia", ...}
//    in the EXACT order defined by COL_ORDER, skipping the pivot column
//    and any empty fields.
////////////////////////////////////////////////////////////////////////////////
function toPostgresStyleJsonString(obj, pivotCol) {
  let pairs = [];
  for (const col of COL_ORDER) {
    // Skip pivot column
    if (col === pivotCol) continue;
    // If user left it blank, skip
    if (!obj[col]) continue;

    // Force everything as a string with quotes
    // If you want an integer for "year", detect that here and do no quotes.
    // e.g. if (col==='year') { pairs.push(`"${col}" : ${obj[col]}`); } else ...
    pairs.push(`"${col}" : "${obj[col]}"`);
  }
  return `{${pairs.join(", ")}}`;
}

////////////////////////////////////////////////////////////////////////////////
// 5) The main logic: build the custom JSON string, show it, MD5-hash it,
//    fetch the partial-hash file, and display the result.
////////////////////////////////////////////////////////////////////////////////
function onLookup() {
  // Gather user selections
  const tableType = document.getElementById("tableType").value.trim();
  const pivotCol = document.getElementById("pivotCol").value.trim();

  if (!tableType || !pivotCol) {
    document.getElementById("result").textContent =
      "Please pick a Table Type and a Pivot Column.";
    return;
  }

  // Build an object of the user-chosen values
  const inputObj = {
    region_name: document.getElementById("region_name").value.trim(),
    sub_region_name: document.getElementById("sub_region_name").value.trim(),
    location_name: document.getElementById("location_name").value.trim(),
    age_group_name_sorted: document.getElementById("age_group_name_sorted").value.trim(),
    age_cluster_name_sorted: document.getElementById("age_cluster_name_sorted").value.trim(),
    sex_name: document.getElementById("sex_name").value.trim(),
    l1_cause_name: document.getElementById("l1_cause_name").value.trim(),
    l2_cause_name: document.getElementById("l2_cause_name").value.trim(),
    year: document.getElementById("year").value.trim()
  };

  // 1) Build the "PostgreSQL style" JSON string with spacing
  const comboStr = toPostgresStyleJsonString(inputObj, pivotCol);
  // Show for debugging
  document.getElementById("jsonString").textContent = comboStr;

  // 2) Compute the MD5
  const fullHash = md5(comboStr);
  const partialHash = fullHash.slice(0, 3);

  // Show the computed hashes
  document.getElementById("hashInfo").textContent =
    `Full Hash: ${fullHash}\nPartial Hash: ${partialHash}`;

  // 3) Fetch from the partial-hash JSON
  const fetchUrl = `data_doc/cachefilter_${tableType}/${pivotCol}/${partialHash}.json`;
  fetch(fetchUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Fetch error: ${response.status} ${response.statusText}\nURL: ${fetchUrl}`);
      }
      return response.text();
    })
    .then(text => {
      let parsed;
      try {
        parsed = JSON.parse(text);
      } catch (err) {
        throw new Error("Failed to parse JSON. Raw content:\n\n" + text);
      }
      const subObject = parsed[fullHash];
      if (!subObject) {
        throw new Error(`No entry for hash ${fullHash} in file ${partialHash}.json`);
      }
      document.getElementById("result").textContent = JSON.stringify(subObject, null, 2);
    })
    .catch(err => {
      document.getElementById("result").textContent = "Error:\n" + err.message;
    });
}
    </script>
</head>
<body>
    <h1>Generating Combination &amp; Hash Lookup (PostgreSQL-Style Spacing)</h1>

    <p>
      1) Select your values in each dropdown.<br/>
      2) Choose which column is the <strong>pivot column</strong> (omitted).<br/>
      3) Choose a <strong>table type</strong>.<br/>
      4) Click <em>“Generate Hash &amp; Lookup”</em>.<br/>
      This constructs a JSON string with spaces (<code>"key" : "val"</code>), 
      matches your PostgreSQL format, then MD5-hashes it.
    </p>

    <!-- Table Type -->
    <label>Table Type:</label><br/>
    <select id="tableType">
      <option value="">-- choose a table type --</option>
      <option value="population">population</option>
      <option value="long">long</option>
      <!-- add more if needed -->
    </select>
    <br/><br/>

    <!-- Pivot Column -->
    <label>Pivot Column:</label><br/>
    <select id="pivotCol"></select>
    <br/><br/>

    <!-- All columns (populated on window.onload) -->
    <fieldset style="width: 600px;">
      <legend>Select Values</legend>

      <label for="year">year:</label><br/>
      <select id="year"></select><br/><br/>

      <label for="region_name">region_name:</label><br/>
      <select id="region_name"></select><br/><br/>

      <label for="sub_region_name">sub_region_name:</label><br/>
      <select id="sub_region_name"></select><br/><br/>

      <label for="location_name">location_name:</label><br/>
      <select id="location_name"></select><br/><br/>

      <label for="age_group_name_sorted">age_group_name_sorted:</label><br/>
      <select id="age_group_name_sorted"></select><br/><br/>

      <label for="age_cluster_name_sorted">age_cluster_name_sorted:</label><br/>
      <select id="age_cluster_name_sorted"></select><br/><br/>

      <label for="sex_name">sex_name:</label><br/>
      <select id="sex_name"></select><br/><br/>

      <label for="l1_cause_name">l1_cause_name:</label><br/>
      <select id="l1_cause_name"></select><br/><br/>

      <label for="l2_cause_name">l2_cause_name:</label><br/>
      <select id="l2_cause_name"></select><br/><br/>
    </fieldset>

    <br/>
    <button onclick="onLookup()">Generate Hash &amp; Lookup</button>

    <h2>Debug Info</h2>
    <p><strong>Exact JSON String that is hashed</strong> (with PostgreSQL-like spacing):</p>
    <pre id="jsonString" style="border:1px solid #ccc; padding:10px; white-space:pre-wrap;"></pre>

    <p><strong>Computed Hash Info</strong>:</p>
    <pre id="hashInfo" style="border:1px solid #ccc; padding:10px; white-space:pre-wrap;"></pre>

    <h2>Lookup Result</h2>
    <pre id="result" style="border:1px solid #ccc; padding:10px; white-space:pre-wrap;"></pre>
</body>
</html>
